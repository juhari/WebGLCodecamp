if(!SceneJS.utils){SceneJS.utils={};}if(!SceneJS.utils.query){SceneJS.utils.query={};}SceneJS.utils.query.QueryNodeMats=function(cfg){this.setConfigs(cfg);};SceneJS.utils.query.QueryNodeMats.prototype.setConfigs=function(cfg){if(!this._cfg){this._cfg={};}if(!cfg){cfg={};}if(!cfg.model&&!cfg.proj&&!cfg.view){throw"SceneJS.utils.query.QueryNodeMats misconfigured - need one or more of model, view and proj";
}this._cfg={model:cfg.model,view:cfg.view,proj:cfg.proj};return this;};SceneJS.utils.query.QueryNodeMats.prototype.execute=function(params,completed){if(!params.nodeId){throw"SceneJS.utils.query.QueryNodeMats.execute expects params.nodeId";}var node=SceneJS.withNode(params.nodeId);this._queryResult=this._walkUpBranch(node,null);
if(this._cfg.model&&(!this._queryResult.modelMat)){this._queryResult.modelMat=this._identityMat4();}if(this._cfg.view&&(!this._queryResult.viewMat)){this._queryResult.viewMat=this._identityMat4();}if(this._cfg.proj&&(!this._queryResult.projMat)){this._queryResult.projMat=this._identityMat4();}if(completed){completed(this);
}return this;};SceneJS.utils.query.QueryNodeMats.prototype.getResults=function(){return this._queryResult;};SceneJS.utils.query.QueryNodeMats.prototype._walkUpBranch=function(node,data){if(!data){data={};}var mat;var type=node.get("type");switch(type){case"rotate":case"translate":case"scale":case"matrix":case"quaternion":if(this._cfg.model){mat=node.get("matrix");
data.modelMat=data.modelMat?this._mulMat4(data.modelMat,mat):mat;}break;case"lookAt":if(this._cfg.view){mat=node.get("matrix");data.viewMat=data.viewMat?this._mulMat4(data.viewMat,mat):mat;}break;case"camera":if(this._cfg.proj){mat=node.get("matrix");data.projMat=data.projMat?this._mulMat4(data.projMat,mat):mat;
}break;case"library":return data;}var parent=node.parent();if(parent){data=this._walkUpBranch(parent,data);}return data;};SceneJS.utils.query.QueryNodeMats._mulMat4=function(a,b){var r=new Array(16);var i=0;var j=0;var k=0;var s=0;for(i=0;i<4;++i){for(j=0;j<4;++j){s=0;for(k=0;k<4;++k){s+=a[i+k*4]*b[k+j*4];
}r[i+j*4]=s;}}return r;};SceneJS.utils.query.QueryNodeMats._identityMat4=function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];};