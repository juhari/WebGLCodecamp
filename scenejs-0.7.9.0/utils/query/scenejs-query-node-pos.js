if(!SceneJS.utils){SceneJS.utils={};}if(!SceneJS.utils.query){SceneJS.utils.query={};}SceneJS.utils.query.QueryNodePos=function(cfg){this.setConfigs(cfg);};SceneJS.utils.query.QueryNodePos.prototype.setConfigs=function(cfg){if(!this._cfg){this._cfg={};}if(!cfg){cfg={};}if(cfg.canvasWidth){this._cfg.canvasWidth=cfg.canvasWidth;
}if(cfg.canvasHeight){this._cfg.canvasHeight=cfg.canvasHeight;}return this;};SceneJS.utils.query.QueryNodePos.prototype.execute=function(params,completed){if(!params.nodeId){throw"SceneJS.utils.query.QueryNodePos.execute expects params.nodeId";}if(this._cfg.canvasWidth||this._cfg.canvasHeight){if(!this._cfg.canvasWidth){throw"SceneJS.utils.query.QueryNodePos misconfigured - canvasHeight given, but canvasWidth omitted";
}else{if(!this._cfg.canvasHeight){throw"SceneJS.utils.query.QueryNodePos misconfigured - canvasWidth given, but canvasHeight omitted";}}}var node=SceneJS.withNode(params.nodeId);var localPos=params.localPos||{};localPos.x=localPos.x||0;localPos.y=localPos.y||0;localPos.z=localPos.z||0;var data=this._walkUpBranch({localPos:[localPos.x,localPos.y,localPos.z]},node,null);
this._queryResult={localPos:localPos,worldPos:{x:data.worldPos[0],y:data.worldPos[1],z:data.worldPos[2]},viewPos:{x:data.viewPos[0],y:data.viewPos[1],z:data.viewPos[2]},cameraPos:{x:data.cameraPos[0],y:data.cameraPos[1],z:data.cameraPos[2]},projPos:{x:data.projPos[0],y:data.projPos[1]}};if(this._cfg.canvasWidth){this._queryResult.canvasPos={x:data.canvasPos[0]+(this._cfg.canvasWidth*0.5),y:this._cfg.canvasHeight-data.canvasPos[1]-(this._cfg.canvasHeight*0.5)};
}if(completed){completed(this);}return this;};SceneJS.utils.query.QueryNodePos.prototype.getResults=function(){return this._queryResult;};SceneJS.utils.query.QueryNodePos.prototype._walkUpBranch=function(params,node,data){if(!data){data={localPos:params.localPos,worldPos:params.localPos};}var mat;var type=node.get("type");
switch(type){case"rotate":case"translate":case"scale":case"matrix":case"quaternion":mat=node.get("matrix");data.worldPos=this._transformPoint3(mat,data.worldPos);break;case"lookAt":var viewMat=node.get("matrix");data.viewMat=viewMat;data.viewPos=this._transformPoint3(viewMat,data.worldPos);if(data.projMat){data.projPos=this._transformPoint3(data.projMat,data.viewPos);
}else{data.projPos=data.viewPos;}break;case"camera":mat=node.get("matrix");data.projMat=mat;break;case"scene":var v=this._normalizeVec2(data.projPos);data.cameraPos=v;if(this._cfg.canvasWidth){var projPos=data.projPos;var x=projPos[0]/projPos[3];var y=projPos[1]/projPos[3];data.canvasPos=[x*this._cfg.canvasWidth*0.5,y*this._cfg.canvasHeight*0.5];
}break;case"library":return data;}var parent=node.parent();if(parent){data=this._walkUpBranch(params,parent,data);}return data;};SceneJS.utils.query.QueryNodePos.prototype._transformPoint3=function(mat,p){return[(mat[0]*p[0])+(mat[4]*p[1])+(mat[8]*p[2])+mat[12],(mat[1]*p[0])+(mat[5]*p[1])+(mat[9]*p[2])+mat[13],(mat[2]*p[0])+(mat[6]*p[1])+(mat[10]*p[2])+mat[14],(mat[3]*p[0])+(mat[7]*p[1])+(mat[11]*p[2])+mat[15]];
};SceneJS.utils.query.QueryNodePos.prototype._normalizeVec2=function(v){var f=1/SceneJS._math_lenVec2(v);return this._mulVec2Scalar(v,f);};SceneJS.utils.query.QueryNodePos.prototype._lenVec2=function(v){return Math.sqrt(this._sqLenVec2(v));};SceneJS.utils.query.QueryNodePos.prototype._sqLenVec2=function(v){return this._dotVector2(v,v);
};SceneJS.utils.query.QueryNodePos.prototype._dotVector2=function(u,v){return(u[0]*v[0]+u[1]*v[1]);};SceneJS.utils.query.QueryNodePos.prototype._mulVec2Scalar=function(v,s){return[v[0]*s,v[1]*s,v[2]*s];};